#!/usr/bin/env bash

build_dir=$1
cache_dir=$2
env_dir=$3
bin_dir=$(cd "$(dirname $0)"; pwd)

for import in "$(dirname ${bin_dir})/lib/"*; do
  source "$import"
done

buildpack_url="https://buildpack-registry.s3.amazonaws.com/buildpacks/heroku/ruby.tgz"
procfile_path=$(get_env_variable ${env_dir} "PROCFILE")
src_app_dir=$(dirname "${build_dir}/${procfile_path}")

require_env_variable $env_dir "PROCFILE"

execute_buildpack $src_app_dir $cache_dir $env_dir $buildpack_url "$(outfile $build_dir)"

copy_procfile  $build_dir $procfile_path
copy_profile_d $build_dir $procfile_path
copy_app_json  $build_dir $procfile_path


