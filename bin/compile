#!/usr/bin/env bash


buildpack_url=https://buildpack-registry.s3.amazonaws.com/buildpacks/heroku/ruby.tgz
buildpack_dir=$(mktemp -d)

curl -s $buildpack_url | tar xvz -C $buildpack_dir

build_dir=$1
cache_dir=$2
env_dir=$3

procfile=$(cat "${env_dir}/PROCFILE")
outfile="${build_dir}/last_pack_release.out"
src_app_dir=$(dirname "${build_dir}/${procfile}")
dst_app_dir=$(dirname "${HOME}/${procfile}")

$buildpack_dir/bin/detect  $src_app_dir
$buildpack_dir/bin/compile $src_app_dir $cache_dir $env_dir
$buildpack_dir/bin/release $src_app_dir > $outfile

cp "${build_dir}/${procfile}" "${build_dir}/Procfile"
sed -i -r -e "s|(bin/[a-z]+)|${dst_app_dir}/\1|g" "${build_dir}/Procfile"

mv "${src_app_dir}/.profile.d" $build_dir
sed -i -e "s|\$HOME/|${dst_app_dir}/|g" "${build_dir}/.profile.d/"*


