#!/usr/bin/env bash


buildpack_url=https://buildpack-registry.s3.amazonaws.com/buildpacks/heroku/ruby.tgz
buildpack_dir=$(mktemp -d)

curl -s $buildpack_url | tar xvz -C $buildpack_dir

build_dir=$1
cache_dir=$2
env_dir=$3

procfile=$(cat "${env_dir}/PROCFILE")
app_dir=$(dirname "${build_dir}/${procfile}")

$buildpack_dir/bin/detect  $app_dir
$buildpack_dir/bin/compile $app_dir $cache_dir $env_dir
$buildpack_dir/bin/release $app_dir > $build_dir/last_pack_release.out

cp "${build_dir}/${procfile}" "${build_dir}/Procfile"
sed -i -r -e "s|(bin/[a-z]+)|${HOME}/$(dirname ${procfile})/\1|g" "${build_dir}/Procfile"

mv $app_dir/.profile.d $build_dir
sed -i -e "s|\$HOME/|\$HOME/$(dirname ${procfile})/|g" "${build_dir}/.profile.d/"*


