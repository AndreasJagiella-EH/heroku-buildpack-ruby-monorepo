#!/usr/bin/env bash


BUILDPACK_URL=https://buildpack-registry.s3.amazonaws.com/buildpacks/heroku/ruby.tgz
BUILDPACK_DIR=$(mktemp -d)

curl -s $BUILDPACK_URL | tar xvz -C $BUILDPACK_DIR

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

PROCFILE=$(cat "${ENV_DIR}/PROCFILE")
APP_DIR=$(dirname "${BUILD_DIR}/${PROCFILE}")

$BUILDPACK_DIR/bin/detect  $APP_DIR
$BUILDPACK_DIR/bin/compile $APP_DIR $CACHE_DIR $ENV_DIR
$BUILDPACK_DIR/bin/release $APP_DIR > $BUILD_DIR/last_pack_release.out

cp "${BUILD_DIR}/${PROCFILE}" "${BUILD_DIR}/Procfile"
sed -i -r -e "s|(bin/[a-z]+)|${HOME}/$(dirname ${PROCFILE})/\1|g" "${BUILD_DIR}/Procfile"

mv $APP_DIR/.profile.d $BUILD_DIR
sed -i -e "s|\$HOME/|\$HOME/$(dirname ${PROCFILE})/|g" "${BUILD_DIR}/.profile.d/"*


